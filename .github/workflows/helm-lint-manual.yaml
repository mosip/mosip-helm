name: Run Lint and Test Charts manually

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'target repo'
        required: true
        default: 'https://github.com/mosip/mosip-helm'
        type: string
      target_branch:
        description: 'target branch'
        required: true
        default: 'gh-pages'
        type: string

jobs:
  lint-chart:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          # ct needs history to compare
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.10.0

      - name: Install python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          check-latest: true

      - name: Install yamllint via pip3
        run: |
          pip3 install yamllint

      - name: Set environment variables
        run: |
          # echo "TARGET BRANCH : ${{ github.event.inputs.target_branch }}"
          echo "TARGET_BRANCH=$(echo ${{ github.event.inputs.target_branch }} )" >> $GITHUB_ENV
          echo "COMMIT_ID=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "TARGET_REPO=$( echo ${{ github.event.inputs.target_repo }} )" >> $GITHUB_ENV

      - name: Add Target repo to git remotes
        run: |
          git remote add target_repo $TARGET_REPO
          git fetch target_repo

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.3.1

      - name: Run chart-testing (lint)
        run: |
          ls -d charts/* > list.txt;
          ct lint --config=.github/chart-testing-config.yaml --chart-dirs=charts --remote=target_repo --target-branch=$TARGET_BRANCH;
  
      - name: Run Health Check Test
        run: |
          while read -r chart; do
            echo -e "\n\nCHART: $chart\n";
          
            chart_name=$( echo $chart | awk -F / '{print $2}' );
            list=$( ls $chart_name-yaml );
          
            echo -e "YAML LIST :";
            echo -e "$list\n"
          
            for yaml in $list; do
              echo -e "YAML : $yaml";
              yamale -s .github/health-check-schema.yaml "$chart_name-yaml/$yaml" --no-strict
            done
          
          done < ./list.txt

      # Commented below tasks as it cannot test MOSIP helm/charts deployment due to dependencies issues
      #- name: Create kind v1.21.1 cluster
      #  uses: helm/kind-action@v1.4.0
      #  with:
      #    node_image: kindest/node:v1.21.1
      #
      #- name: Run chart-testing (install)
      #  run: |
      #    while read -r chart; do
      #      echo -e "\nCHART: $chart\n";
      #      ct install --config=.github/chart-testing-config.yaml --charts=$chart --remote=target_repo --target-branch=$TARGET_BRANCH;
      #    done < ./list.txt
